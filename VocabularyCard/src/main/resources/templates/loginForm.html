<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Vocabulary Card</title>
<link th:href="@{/css/style.css}" rel="stylesheet" type="text/css">
<script>window.speechSynthesis.getVoices();</script>
</head>
<body>
<script type="text/javascript" th:src="@{/js/jquery-3.6.0.min.js}"></script>
	<header>
		<h1 class="title-container">
			<span class="title">Vocabulary Card</span>
		</h1>
	</header>
	<div class="login-container">
	<div id="loginFloat">
		<div th:if="${msg!=null}" class="message">
			<div th:if="${msg.msgType=='E'}" class="error">
				<span class="icon E">×</span> <span th:text="${msg.msgText}"></span>
			</div>
			<div th:if="${msg.msgType=='I'}" class="information">
				<span class="icon I">i</span> <span th:text="${msg.msgText}"></span>
			</div>
		</div>
		<div class="login">
			<form th:action="@{/login/do}" method="post" th:object="${loginData}">
				<table>
					<tr>
						<th class="valign">ID</th>
					</tr>
					<tr>
						<td><input type="password" name="loginId"
							th:value="*{loginId}" class="loginInput">
							<div th:if="${#fields.hasErrors('loginId')}"
								th:errors="*{loginId}"></div></td>
					</tr>
					<tr>
						<th class="valign">パスワード</th>
					</tr>
					<tr>
						<td><input type="password" name="password"
							th:value="*{password}" class="loginInput">
							<div th:if="${#fields.hasErrors('password')}"
								th:errors="*{password}"></div></td>
					</tr>
				</table>
				<button type="submit" class="loginButton pointer">ログイン</button>
				<a th:href="@{/regist}">新規登録</a>
			</form>
		</div>
		</div>

		<div class="topText">
			<div class="topic-container">
			<div class="topic-containerB">Vocabulary Cardは、単語帳を作成してそのままテストに活用できるWEBアプリです。</div>
			</div>
		</div>
		<div class="float-end"></div><!-- sample-containerの高さを確定させるため -->
		<div><span class="textForMobile"><img alt="menu" th:src="@{/images/menu.png}"
					class="textForMobile displayNone"> をタップし、</span>「カード作成」フォームからお試しでカード作成ができます。</div>
		<div>言語と voice を選択し、<button>再生</button>をクリックすると音声が再生されます。</div>
		<div><button>⇔</button>でテスト ⇔ 答え合わせを切り替えられます。</div>
		<div class="sample-container">
			<div class="sampleMenu">
				<img alt="menu" th:src="@{/images/menu.png}"
					class="menuForSample pointer displayNone">
				<p class="sampleText">SAMPLE</p>
				<div id="sampleMenuArea" class="">
					<table class="flashCardButton">
						<tr>
							<td class="label orange pointer" id="L1flash">L1</td>
						</tr>
						<tr>
							<td class="separator"></td>
						</tr>
						<tr>
							<td class="label orange pointer" id="L2flash">L2</td>
						</tr>
					</table>
					<span>(テストモード切り替え)</span>
					<div id="hint" class="gray pointer">Hint</div>
					<span>(1 文字目を表示)</span>
					<br>
					<div id="speech-container" class="form frameBorder sampleForm">
						<div id="volume-container">
							<img alt="menu" th:src="@{/images/speaker.png}" class="speaker">
							<input type="range" min=0 max=1 step=0.1 id="volume">
						</div>
						<div id="lang-container">
							<div>読み上げ設定</div>
							<span class="label">L1</span> <select id="lang1">
								<option value="en-US">英語(アメリカ)</option>
								<option value="en-GB">英語(イギリス)</option>
								<option value="zh-CN">簡体字(中国)</option>
								<option value="zh-HK">繁体字(香港)</option>
								<option value="zh-TW">繁体字(台湾)</option>
								<option value="ko-KR">韓国語</option>
								<option value="de-DE">ドイツ語</option>
								<option value="es-ES">スペイン語</option>
								<option value="fr-FR">フランス語</option>
								<option value="hi-IN">ヒンディー語</option>
								<option value="id-ID">インドネシア語</option>
								<option value="it-IT">イタリア語</option>
								<option value="nl-NL">オランダ語</option>
								<option value="pl-PL">ポーランド語</option>
								<option value="pt-BR">ポルトガル語</option>
								<option value="ru-RU">ロシア語</option>
								<option value="jp-JP">日本語</option>
							</select> <br> <span class="label">L2</span> <select id="lang2">
								<option value="en-US">英語(アメリカ)</option>
								<option value="en-GB">英語(イギリス)</option>
								<option value="zh-CN">簡体字(中国)</option>
								<option value="zh-HK">繁体字(香港)</option>
								<option value="zh-TW">繁体字(台湾)</option>
								<option value="ko-KR">韓国語</option>
								<option value="de-DE">ドイツ語</option>
								<option value="es-ES">スペイン語</option>
								<option value="fr-FR">フランス語</option>
								<option value="hi-IN">ヒンディー語</option>
								<option value="id-ID">インドネシア語</option>
								<option value="it-IT">イタリア語</option>
								<option value="nl-NL">オランダ語</option>
								<option value="pl-PL">ポーランド語</option>
								<option value="pt-BR">ポルトガル語</option>
								<option value="ru-RU">ロシア語</option>
								<option value="jp-JP">日本語</option>
							</select><br> <span class="label">voice</span> <select
								id="voiceSelect">
							</select>
						</div>
					</div>
					<!-- 追加用form -->
					<div class="frameBorder form sampleForm">
						<p class="label">LANGUAGE1</p>
						<input type="text" name="spelling1" placeholder="word 1(必須)"
							class="createForm menuInput sampleL1input" maxlength="50" autocomplete="off">
						<div class="error"></div>
						<input type="text" name="spelling2" placeholder="word 2"
							class="createForm menuInput sampleL1input" maxlength="50" autocomplete="off"> <input
							type="text" name="spelling3" placeholder="word 3"
							class="createForm menuInput sampleL1input" maxlength="50" autocomplete="off">
						<p class="label">LANGUAGE2</p>
						<input type="text" name="meaning1" placeholder="word 1"
							class="createForm menuInput sampleL2input" maxlength="50" autocomplete="off">
						<input type="text" name="meaning2" placeholder="word 2"
							class="createForm menuInput sampleL2input" maxlength="50" autocomplete="off">
						<input type="text" name="meaning3" placeholder="word 3"
							class="createForm menuInput sampleL2input" maxlength="50" autocomplete="off">
						<button type="submit" id="doCreate" class="keep pointer">カード作成</button>
					</div>
				</div>
			</div>
			<div class="sampleCard">
				<section class="sampleWordList floatCancel">
					<p class="label">L1</p>
					<div class="L1">
						<div class="eachWord">
							<span class="L1hidden correct" id="spelling1">sample</span> <span
								class="L1writeIn displayNone writeIn"><input type="text"
								placeholder=""><span class="L1Length"></span></span>
							<button class="check L1check pointer">⇔</button>
							<button class="L1speakButton pointer">再生</button>
							<br>
						</div>
					</div>
					<p class="label">L2</p>
					<div class="L2">
						<div class="eachWord">
							<span class="L2hidden correct">サンプル</span> <span
								class="L2writeIn displayNone writeIn"><input type="text"
								placeholder=""><span class="L2Length"></span></span>
							<button class="check L2check pointer">⇔</button>
							<button class="L2speakButton pointer">再生</button>
							<br> <span class="L2hidden correct">見本</span> <span
								class="L2writeIn displayNone writeIn"><input type="text"
								placeholder=""><span class="L2Length"></span></span>
							<button class="check L2check pointer">⇔</button>
							<button class="L2speakButton pointer">再生</button>
							<br>
						</div>
					</div>
				</section>
			</div>

			<div class="sampleCard">
				<section class="sampleWordList floatCancel">
					<p class="label">L1</p>
					<div class="L1">
						<div class="eachWord">
							<span class="L1hidden correct sampleL1hidden" id="spelling1">word1</span>
							<span class="L1writeIn displayNone writeIn"><input
								type="text" placeholder=""><span class="L1Length"></span></span>
							<button class="check L1check pointer">⇔</button>
							<button class="L1speakButton pointer">再生</button>
							<br> <span class="L1hidden correct sampleL1hidden"
								id="spelling2">word2</span> <span
								class="L1writeIn displayNone writeIn"><input type="text"
								placeholder=""><span class="L1Length"></span></span>
							<button class="check L1check pointer">⇔</button>
							<button class="L1speakButton pointer">再生</button>
							<br> <span class="L1hidden correct sampleL1hidden"
								id="spelling3">word3</span> <span
								class="L1writeIn displayNone writeIn"><input type="text"
								placeholder=""><span class="L1Length"></span></span>
							<button class="check L1check pointer">⇔</button>
							<button class="L1speakButton pointer">再生</button>
						</div>
					</div>
					<p class="label">L2</p>
					<div class="L2">
						<div class="eachWord">
							<span class="L2hidden correct sampleL2hidden">word1</span> <span
								class="L2writeIn displayNone writeIn"><input type="text"
								placeholder=""><span class="L2Length"></span></span>
							<button class="check L2check pointer">⇔</button>
							<button class="L2speakButton pointer">再生</button>
							<br> <span class="L2hidden correct sampleL2hidden">word2</span>
							<span class="L2writeIn displayNone writeIn"><input
								type="text" placeholder=""><span class="L2Length"></span></span>
							<button class="check L2check pointer">⇔</button>
							<button class="L2speakButton pointer">再生</button>
							<br> <span class="L2hidden correct sampleL2hidden">word3</span>
							<span class="L2writeIn displayNone writeIn"><input
								type="text" placeholder=""><span class="L2Length"></span></span>
							<button class="check L2check pointer">⇔</button>
							<button class="L2speakButton pointer">再生</button>
							<br>
						</div>
					</div>
				</section>
				<br>
				<div>※「カード作成」ボタンで上書きされます。</div>
				<div>※ブラウザによっては音声読みあげに対応していない場合があります。</div>
			</div>
			<div class="float-end"></div><!-- sample-containerの高さを確定させるため -->
		</div>
	</div>
		<div class="copyright">© 2021 KMTS</div>
	<script type="text/javascript">
	//spellingTest機能
	var L1flash=document.getElementById("L1flash");
	var L2flash=document.getElementById("L2flash");
    var L1hidden=document.querySelectorAll(".L1hidden");
	var L2hidden=document.querySelectorAll(".L2hidden");
	var L1writeIn=document.querySelectorAll(".L1writeIn");
	var L2writeIn=document.querySelectorAll(".L2writeIn");
	var L1Length=document.querySelectorAll(".L1Length");
	var L2Length=document.querySelectorAll(".L2Length");
	//正解の単語の文字数を表示


	//回答⇔一覧の切り替えを設定
	//表示=0,非表示=1
	let currentL1Switch=0;
	let currentL2Switch=0;
	$("#L1flash").on("click",function(){
		for(let i=0;i<L1hidden.length;i++){
			L1Length[i].textContent="(" + L1hidden[i].textContent.length + ")";
		}
		if(currentL1Switch==0){
			for(let i=0;i<L1hidden.length;i++){
				if(!L1hidden[i].classList.contains('displayNone')){
					L1hidden[i].classList.toggle('displayNone');
					L1writeIn[i].classList.toggle('displayNone');
				}
			}
			currentL1Switch=1;
			$("#L1flash").addClass("gray");
			$("#L1flash").removeClass("orange");
		}else{
			for(let i=0;i<L1hidden.length;i++){
				if(L1hidden[i].classList.contains('displayNone')){
					L1hidden[i].classList.toggle('displayNone');
					L1writeIn[i].classList.toggle('displayNone');
				}
			}
			currentL1Switch=0;
			$("#L1flash").addClass("orange");
			$("#L1flash").removeClass("gray");
		}
	});
	$("#L2flash").on("click",function(){
		for(let i=0;i<L2hidden.length;i++){
			L2Length[i].textContent="(" + L2hidden[i].textContent.length + ")";
		}
		if(currentL2Switch==0){
			for(let i=0;i<L2hidden.length;i++){
				if(!L2hidden[i].classList.contains('displayNone')){
					L2hidden[i].classList.toggle('displayNone');
					L2writeIn[i].classList.toggle('displayNone');
				}
			}
			currentL2Switch=1;
			$("#L2flash").addClass("gray");
			$("#L2flash").removeClass("orange");
		}else{
			for(let i=0;i<L2hidden.length;i++){
				if(L2hidden[i].classList.contains('displayNone')){
					L2hidden[i].classList.toggle('displayNone');
					L2writeIn[i].classList.toggle('displayNone');
				}
			}
			currentL2Switch=0;
			$("#L2flash").addClass("orange");
			$("#L2flash").removeClass("gray");
		}
	});
	//スペルを一文字ごとに判定する
	//イベントを作成
	let clickEvent=new MouseEvent("click");
	//let check=document.querySelectorAll(".check");
	let L1check=document.querySelectorAll(".L1check");
	let L2check=document.querySelectorAll(".L2check");
    let perChar=[];
    let result="<p class='correct'>";
    //答え合わせ用ボタンごとにイベントを設定
  	function checkAndMove(check,answerArray,correctArray,writeInArray){
  		for(let i=0;i<check.length;i++){
  	  		//エンターキーを押したときにcheckボタンをクリックするイベントを発火させる
  	  		answerArray[i].addEventListener('keypress',(event)=>{
  	  			if(event.keyCode===13){
  	  				check[i].dispatchEvent(clickEvent);
  	  			}
  	  		});
  	  		//クリックイベントを設定
  	  		check[i].addEventListener('click',(event)=>{
  	        let answer=answerArray[i].value;
  	        let correct=correctArray[i].textContent;
  	        let result="<span class='correct'>";
  	        let rightChar=[];
  	        //回答を一文字ずつ取得し、正解と比較
  	        for(let j=0;j<answer.length;j++){
  	        	//正解の文字列を超えた場合はbreak
  	      		if(j>correct.length)break;
  	        	//正解の文字番号を配列に格納
  	      		if(answer.charAt(j)==correct.charAt(j)){
  	            rightChar.push(j);
  	      		}
  	      	}
  	        //正解の文字はそのまま文字列に追加、不正解は<span>を付けて追加
  	        for(let k=0;k<correct.length;k++){
  	          if(rightChar.includes(k)){
  	            result+=correct.charAt(k);
  	          }else{
  	            result+=('<span class="red">'+correct.charAt(k)+'</span>');
  	          }
  	        }
  	        result+="</span>"
  	        correctArray[i].innerHTML=result;
  	  		//回答欄⇔答えの切り替え
  	  		writeInArray[i].classList.toggle('displayNone');
  	  		correctArray[i].classList.toggle('displayNone');
  	  		//次の回答欄にフォーカス
  	  		if(i+1<answerArray.length){
  	  			answerArray[i+1].focus();
  	  		}
  	  		});
  	  	}
    }
    //checkAndMoveを設定
    let L1answer=document.querySelectorAll(".L1writeIn>input");
    let L2answer=document.querySelectorAll(".L2writeIn>input");
  	checkAndMove(L1check,L1answer,L1hidden,L1writeIn);
  	checkAndMove(L2check,L2answer,L2hidden,L2writeIn);

  	//サンプル用のカード
  	var sampleL1hidden=document.getElementsByClassName("sampleL1hidden");
  	function checkAndMoveForSample(){

  	}

  	//頭文字を表示する
	let allAnswers=document.querySelectorAll(".writeIn>input");
    let allCorrects=document.querySelectorAll(".correct");
    let hint=document.getElementById("hint");
    let hintSwitch=0;//0=off,1=on
    hint.addEventListener("click",(event)=>{
    	if(hintSwitch==0){
    		for(let i=0;i<allCorrects.length;i++){
    			let answer=allAnswers[i];
    			let correct=allCorrects[i];
    			answer.placeholder=correct.textContent.charAt(0);
    		}
    		hintSwitch=1;
    		hint.classList.add("orange");
    		hint.classList.remove("gray");
    	}else{
    		for(let i=0;i<allCorrects.length;i++){
    			console.log("a");
    			let answer=allAnswers[i];
    			answer.placeholder="";
    		}
    		hintSwitch=0;
    		hint.classList.add("gray");
    		hint.classList.remove("orange");
    	}
    });

    //読みあげ機能
    let voice=window.speechSynthesis.getVoices();
	let voiceSelect=document.getElementById("voiceSelect");
	let selectedVoice;
	let lang1Array=document.querySelectorAll("#lang1>option");
	let lang2Array=document.querySelectorAll("#lang2>option");
	//voiceのoptionを作成、デバイス、ブラウザごとに異なる
	for(let i=0;i<voice.length;i++){
		let option='<option value="'+voice[i].name+'">'+voice[i].name+'('+voice[i].lang+')</option>' ;
		console.log(voice[i].name+"("+voice[i].lang+")");
		voiceSelect.insertAdjacentHTML("beforeend",option);
	}
    if("speechSynthesis" in window){
   	 	var L1speak=document.getElementsByClassName("L1speakButton");
    	var L2speak=document.getElementsByClassName("L2speakButton");
   		for(let i=0;i<L1speak.length;i++){
    		L1speak[i].addEventListener("click",function(){
    			const uttr=new SpeechSynthesisUtterance(L1hidden[i].textContent);
    			uttr.lang=document.getElementById("lang1").value;
    			uttr.volume=document.getElementById("volume").value;
    			let currentVoicename=voiceSelect.value;
    			voice.forEach(function(v){
    				if(v.name==currentVoicename)
    					uttr.voice=v;
    			})
    			speechSynthesis.speak(uttr);
    		});
    	}
		for(let i=0;i<L2speak.length;i++){
	    	L2speak[i].addEventListener("click",function(){
    			const uttr=new SpeechSynthesisUtterance(L2hidden[i].textContent);
    			uttr.lang=document.getElementById("lang2").value;
    			uttr.volume=document.getElementById("volume").value;
    			let currentVoicename=voiceSelect.value;
    			voice.forEach(function(v){
    				if(v.name==currentVoicename)
    					uttr.voice=v;
    			})
	    		speechSynthesis.speak(uttr);
    		});
    	}
    }else{
    	$("#speechNotFound").removeClass("displayNone");
    }

    var sampleL1hidden=$(".sampleL1hidden");
    var sampleL2hidden=$(".sampleL2hidden");
    var sampleL1input=$(".sampleL1input");
    var sampleL2input=$(".sampleL2input");
    $("#doCreate").on("click",function(){

    	for(let i=0;i<sampleL1hidden.length;i++){
    		sampleL1hidden[i].textContent=sampleL1input[i].value;
    		sampleL2hidden[i].textContent=sampleL2input[i].value;
    	}
    });

    if(screen.width<480){
		$(".menuForSample").toggleClass("displayNone");
		$("#sampleMenuArea").toggleClass("displayNone");
		$(".menuForSample").on("click",function(){
			console.log("a");
			$("#sampleMenuArea").toggleClass("displayNone");
		});
    }

	</script>
</body>
</html>